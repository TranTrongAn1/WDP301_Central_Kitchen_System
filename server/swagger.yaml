openapi: 3.0.0
info:
  title: Kendo Mooncake Central Kitchen System API
  description: |
    API documentation for the Kendo Mooncake Central Kitchen System with full traceability support.
    
    **Key Features:**
    - Feature 1: Admin & System Management
    - Feature 2: Inventory & Sourcing (Input Traceability)
    - Feature 3: Production Management (Output Traceability)
    - Feature 4: Logistics & Supply Chain (Order-to-Delivery)
    - Feature 5: Store & Distribution Management
    
    **Traceability Chain:**
    Supplier → Ingredient Batch → Ingredient → Product Recipe → Production Plan → Finished Batch → Order → Delivery Trip → Store Inventory
    Order → Invoice (Financial Tracking)
  version: 2.0.0
  contact:
    name: API Support
    email: support@kendomooncake.com

servers:
  - url: http://localhost:5000
    description: Development server
  - url: https://api.kendomooncake.com
    description: Production server

tags:
  - name: Health
    description: System health check endpoints
  - name: Authentication
    description: User authentication and authorization endpoints
  - name: Categories
    description: Product category management endpoints
  - name: Suppliers
    description: Supplier management for raw material sourcing (Feature 2)
  - name: Ingredients
    description: Ingredient and raw material management endpoints
  - name: Ingredient Batches
    description: Ingredient batch import and FEFO tracking (Feature 2)
  - name: Products
    description: Product management with recipe and bundle capabilities
  - name: Production Plans
    description: Production plan management and scheduling (Feature 3)
  - name: Production
    description: Production batch execution and completion tracking
  - name: Finished Batches
    description: Finished goods batch tracking with production plan linkage (Feature 3)
  - name: Inventory
    description: Store inventory tracking and management (Feature 5)
  - name: Stores
    description: Store management and retail location operations
  - name: Users
    description: User and staff administration endpoints
  - name: Logistics
    description: Order management and delivery operations
  - name: Feedback
    description: Order feedback and rating management

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health Check
      description: Check if the API server is running
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  timestamp:
                    type: string

  /api/auth/register:
    post:
      tags:
        - Authentication
      summary: Register new user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
                - fullName
                - email
                - roleId
              properties:
                username:
                  type: string
                password:
                  type: string
                fullName:
                  type: string
                email:
                  type: string
                roleId:
                  type: string
                storeId:
                  type: string
      responses:
        '201':
          description: User registered successfully

  /api/auth/login:
    post:
      tags:
        - Authentication
      summary: Login user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                  example: 'admin'
                password:
                  type: string
                  example: 'admin123'
      responses:
        '200':
          description: Login successful

  /api/auth/me:
    get:
      tags:
        - Authentication
      summary: Get current user
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Successfully retrieved user

  /api/categories:
    get:
      tags:
        - Categories
      summary: Get all categories
      description: Retrieve list of all product categories
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Successfully retrieved categories
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  count:
                    type: integer
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        _id:
                          type: string
                        categoryName:
                          type: string
                        createdAt:
                          type: string
                        updatedAt:
                          type: string
    post:
      tags:
        - Categories
      summary: Create category
      description: Create a new product category (Admin, Kitchen_Manager only)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - categoryName
              properties:
                categoryName:
                  type: string
                  example: 'Bánh Nướng'
      responses:
        '201':
          description: Category created successfully
        '400':
          description: Invalid input or duplicate category name

  /api/categories/{id}:
    get:
      tags:
        - Categories
      summary: Get category by ID
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Category ID
      responses:
        '200':
          description: Successfully retrieved category
        '404':
          description: Category not found
    put:
      tags:
        - Categories
      summary: Update category
      description: Update an existing category (Admin, Kitchen_Manager only)
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Category ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                categoryName:
                  type: string
                  example: 'Bánh Dẻo'
      responses:
        '200':
          description: Category updated successfully
        '400':
          description: Invalid input or duplicate category name
        '404':
          description: Category not found
    delete:
      tags:
        - Categories
      summary: Delete category
      description: Delete a category (Admin, Kitchen_Manager only). Cannot delete if category is used by products.
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Category ID
      responses:
        '200':
          description: Category deleted successfully
        '400':
          description: Cannot delete - category is in use
        '404':
          description: Category not found

  # ============================================================
  # FEATURE 2: SUPPLIERS (Sourcing & Traceability)
  # ============================================================
  /api/suppliers:
    get:
      tags:
        - Suppliers
      summary: Get all suppliers
      description: Retrieve list of all suppliers for raw material sourcing
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Successfully retrieved suppliers
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  count:
                    type: integer
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Supplier'
    post:
      tags:
        - Suppliers
      summary: Create supplier
      description: Register a new supplier (Admin, Manager only)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - contactPerson
                - phone
                - email
                - address
              properties:
                name:
                  type: string
                  example: 'Golden Harvest Supplier'
                contactPerson:
                  type: string
                  example: 'Nguyen Van A'
                phone:
                  type: string
                  example: '+84-28-12345678'
                email:
                  type: string
                  example: 'contact@goldenharvest.vn'
                address:
                  type: string
                  example: 'Industrial Zone, Binh Duong Province'
      responses:
        '201':
          description: Supplier created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Supplier'
        '400':
          description: Invalid input or duplicate supplier name

  /api/suppliers/{id}:
    get:
      tags:
        - Suppliers
      summary: Get supplier by ID
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Supplier ID
      responses:
        '200':
          description: Successfully retrieved supplier
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Supplier'
        '404':
          description: Supplier not found
    put:
      tags:
        - Suppliers
      summary: Update supplier
      description: Update an existing supplier (Admin, Manager only)
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Supplier ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                contactPerson:
                  type: string
                phone:
                  type: string
                email:
                  type: string
                address:
                  type: string
      responses:
        '200':
          description: Supplier updated successfully
        '400':
          description: Invalid input
        '404':
          description: Supplier not found
    delete:
      tags:
        - Suppliers
      summary: Delete supplier
      description: Delete a supplier (Admin only). Cannot delete if supplier has active batches.
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Supplier ID
      responses:
        '200':
          description: Supplier deleted successfully
        '400':
          description: Cannot delete - supplier has active batches
        '404':
          description: Supplier not found

  # ============================================================
  # FEATURE 2: INGREDIENTS (Updated with ingredientName)
  # ============================================================
    get:
      tags:
        - Categories
      summary: Get category by ID
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Category ID
      responses:
        '200':
          description: Successfully retrieved category
        '404':
          description: Category not found
    put:
      tags:
        - Categories
      summary: Update category
      description: Update an existing category (Admin, Kitchen_Manager only)
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Category ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                categoryName:
                  type: string
                  example: 'Bánh Dẻo'
      responses:
        '200':
          description: Category updated successfully
        '400':
          description: Invalid input or duplicate category name
        '404':
          description: Category not found
    delete:
      tags:
        - Categories
      summary: Delete category
      description: Delete a category (Admin, Kitchen_Manager only). Cannot delete if category is used by products.
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Category ID
      responses:
        '200':
          description: Category deleted successfully
        '400':
          description: Cannot delete - category is in use
        '404':
          description: Category not found

  /api/ingredients:
    get:
      tags:
        - Ingredients
      summary: Get all ingredients
      description: Retrieve list of all raw materials and ingredients with total quantities
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: lowStock
          schema:
            type: boolean
          description: Filter ingredients below warning threshold
      responses:
        '200':
          description: Successfully retrieved ingredients
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  count:
                    type: integer
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Ingredient'
    post:
      tags:
        - Ingredients
      summary: Create ingredient
      description: Create a new ingredient (Admin, Kitchen_Manager only)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ingredientName
                - unit
                - costPrice
                - warningThreshold
              properties:
                ingredientName:
                  type: string
                  example: 'Flour'
                  description: 'Name of the ingredient (must be unique)'
                unit:
                  type: string
                  example: 'kg'
                  description: 'Unit of measurement (stored in lowercase)'
                costPrice:
                  type: number
                  example: 25000
                  description: 'Cost per unit in VND'
                warningThreshold:
                  type: number
                  example: 100
                  description: 'Low stock alert threshold'
                totalQuantity:
                  type: number
                  example: 0
                  description: 'Initial total quantity (default: 0, updated via batches)'
      responses:
        '201':
          description: Ingredient created successfully
        '400':
          description: Invalid input or duplicate ingredient name

  /api/ingredients/{id}:
    get:
      tags:
        - Ingredients
      summary: Get ingredient by ID
      description: Get detailed ingredient information including total quantity across all batches
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Ingredient ID
      responses:
        '200':
          description: Successfully retrieved ingredient
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Ingredient'
        '404':
          description: Ingredient not found
    put:
      tags:
        - Ingredients
      summary: Update ingredient
      description: Update an existing ingredient (Admin, Kitchen_Manager only)
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Ingredient ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                ingredientName:
                  type: string
                  example: 'Salted Egg Yolk'
                unit:
                  type: string
                  example: 'pcs'
                costPrice:
                  type: number
                  example: 5000
                warningThreshold:
                  type: number
                  example: 200
      responses:
        '200':
          description: Ingredient updated successfully
        '400':
          description: Invalid input or duplicate ingredient name
        '404':
          description: Ingredient not found
    delete:
      tags:
        - Ingredients
      summary: Delete ingredient
      description: Delete an ingredient (Admin, Kitchen_Manager only). Cannot delete if ingredient is used in product recipes or has active batches.
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Ingredient ID
      responses:
        '200':
          description: Ingredient deleted successfully
        '400':
          description: Cannot delete - ingredient is used in recipes or has active batches
        '404':
          description: Ingredient not found

  # ============================================================
  # FEATURE 2: INGREDIENT BATCHES (Import & FEFO Tracking)
  # ============================================================
  /api/ingredients/{id}/batches:
    post:
      tags:
        - Ingredient Batches
      summary: Import ingredient batch (CRITICAL for Traceability)
      description: |
        Import a new batch of ingredients from a supplier. This creates full traceability from supplier to ingredient.
        The system automatically updates the parent ingredient's totalQuantity.
        
        **Traceability:** Supplier → Ingredient Batch → Ingredient
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Ingredient ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - supplierId
                - batchCode
                - initialQuantity
                - price
                - expiryDate
              properties:
                supplierId:
                  type: string
                  example: '60d5ec49f1b2c8b1f8e4e1a1'
                  description: 'REQUIRED: ID of the supplier providing this batch'
                batchCode:
                  type: string
                  example: 'IB-FLOUR-20260129-001'
                  description: 'Unique batch code (auto-uppercase)'
                initialQuantity:
                  type: number
                  example: 500
                  description: 'Quantity being imported'
                price:
                  type: number
                  example: 25000
                  description: 'Price per unit for this batch'
                expiryDate:
                  type: string
                  format: date
                  example: '2026-12-31'
                  description: 'Expiry date (must be in the future)'
                receivedDate:
                  type: string
                  format: date
                  example: '2026-01-29'
                  description: 'Date received (default: today)'
      responses:
        '201':
          description: Ingredient batch imported successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/IngredientBatch'
        '400':
          description: Invalid input (e.g., expiry date in past, duplicate batch code)
        '404':
          description: Ingredient or Supplier not found
    get:
      tags:
        - Ingredient Batches
      summary: Get all batches for an ingredient
      description: Retrieve all batches for a specific ingredient, sorted by expiry date (FEFO)
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Ingredient ID
        - in: query
          name: activeOnly
          schema:
            type: boolean
            default: true
          description: Show only active batches
      responses:
        '200':
          description: Successfully retrieved batches
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  count:
                    type: integer
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/IngredientBatch'

  /api/ingredient-batches:
    get:
      tags:
        - Ingredient Batches
      summary: Get all ingredient batches
      description: Retrieve all ingredient batches with filtering options
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: supplierId
          schema:
            type: string
          description: Filter by supplier
        - in: query
          name: expiring
          schema:
            type: integer
          description: Filter batches expiring within X days
        - in: query
          name: isActive
          schema:
            type: boolean
          description: Filter by active status
      responses:
        '200':
          description: Successfully retrieved batches
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  count:
                    type: integer
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/IngredientBatch'

  /api/ingredient-batches/{id}:
    get:
      tags:
        - Ingredient Batches
      summary: Get ingredient batch by ID
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Successfully retrieved batch
        '404':
          description: Batch not found
    put:
      tags:
        - Ingredient Batches
      summary: Update ingredient batch
      description: Update batch details (e.g., adjust quantity for corrections)
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                currentQuantity:
                  type: number
                price:
                  type: number
                isActive:
                  type: boolean
      responses:
        '200':
          description: Batch updated successfully
        '404':
          description: Batch not found

  # ============================================================
  # FEATURE 3: PRODUCTS (with Recipe & Bundles)
  # ============================================================
    get:
      tags:
        - Ingredients
      summary: Get all ingredients
      description: Retrieve list of all raw materials and ingredients
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Successfully retrieved ingredients
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  count:
                    type: integer
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        _id:
                          type: string
                        ingredientName:
                          type: string
                        unit:
                          type: string
                        costPrice:
                          type: number
                        warningThreshold:
                          type: number
                        createdAt:
                          type: string
                        updatedAt:
                          type: string
    post:
      tags:
        - Ingredients
      summary: Create ingredient
      description: Create a new ingredient (Admin, Kitchen_Manager only)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ingredientName
                - unit
                - costPrice
                - warningThreshold
              properties:
                ingredientName:
                  type: string
                  example: 'Bột mì'
                unit:
                  type: string
                  example: 'kg'
                  description: 'Unit of measurement (stored in lowercase)'
                costPrice:
                  type: number
                  example: 20000
                  description: 'Cost per unit in VND'
                warningThreshold:
                  type: number
                  example: 10
                  description: 'Low stock alert threshold'
      responses:
        '201':
          description: Ingredient created successfully
        '400':
          description: Invalid input or duplicate ingredient name

  /api/ingredients/{id}:
    get:
      tags:
        - Ingredients
      summary: Get ingredient by ID
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Ingredient ID
      responses:
        '200':
          description: Successfully retrieved ingredient
        '404':
          description: Ingredient not found
    put:
      tags:
        - Ingredients
      summary: Update ingredient
      description: Update an existing ingredient (Admin, Kitchen_Manager only)
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Ingredient ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                ingredientName:
                  type: string
                  example: 'Trứng muối'
                unit:
                  type: string
                  example: 'quả'
                costPrice:
                  type: number
                  example: 5000
                warningThreshold:
                  type: number
                  example: 20
      responses:
        '200':
          description: Ingredient updated successfully
        '400':
          description: Invalid input or duplicate ingredient name
        '404':
          description: Ingredient not found
    delete:
      tags:
        - Ingredients
      summary: Delete ingredient
      description: Delete an ingredient (Admin, Kitchen_Manager only). Cannot delete if ingredient is used in product recipes.
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Ingredient ID
      responses:
        '200':
          description: Ingredient deleted successfully
        '400':
          description: Cannot delete - ingredient is used in recipes
        '404':
          description: Ingredient not found

  /api/products:
    get:
      tags:
        - Products
      summary: Get all products
      description: Retrieve list of all products with recipes and bundle information
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: categoryId
          schema:
            type: string
          description: Filter by category
      responses:
        '200':
          description: Successfully retrieved products
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  count:
                    type: integer
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Product'
    post:
      tags:
        - Products
      summary: Create product
      description: |
        Create a new product with recipe (ingredients) or bundle items (other products).
        
        **Recipe Products:** Use `recipe` array with ingredientId and quantity per unit
        **Bundle Products:** Use `bundleItems` array with childProductId and quantity
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - sku
                - categoryId
                - price
                - shelfLifeDays
              properties:
                name:
                  type: string
                  example: 'Green Bean Mooncake'
                sku:
                  type: string
                  example: 'MOON-GB-001'
                  description: 'Unique product code'
                categoryId:
                  type: string
                  example: '60d5ec49f1b2c8b1f8e4e1a1'
                price:
                  type: number
                  example: 150000
                  description: 'Selling price in VND'
                shelfLifeDays:
                  type: number
                  example: 30
                  description: 'Shelf life in days (used to calculate expiry date)'
                image:
                  type: string
                  example: 'https://example.com/green-bean-mooncake.jpg'
                recipe:
                  type: array
                  description: 'Array of ingredients (for manufactured products)'
                  items:
                    type: object
                    properties:
                      ingredientId:
                        type: string
                      quantity:
                        type: number
                        description: 'Quantity per 1 unit of product'
                  example:
                    - ingredientId: '60d5ec49f1b2c8b1f8e4e1a2'
                      quantity: 0.05
                    - ingredientId: '60d5ec49f1b2c8b1f8e4e1a3'
                      quantity: 1
                bundleItems:
                  type: array
                  description: 'Array of child products (for bundle/combo products)'
                  items:
                    type: object
                    properties:
                      childProductId:
                        type: string
                      quantity:
                        type: number
                  example:
                    - childProductId: '60d5ec49f1b2c8b1f8e4e1a4'
                      quantity: 2
      responses:
        '201':
          description: Product created successfully
        '400':
          description: Invalid input or duplicate SKU

  /api/products/{id}:
    get:
      tags:
        - Products
      summary: Get product by ID
      description: Get detailed product information with populated recipe and bundle items
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Product ID
      responses:
        '200':
          description: Successfully retrieved product
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Product'
        '404':
          description: Product not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    put:
      tags:
        - Products
      summary: Update product
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                sku:
                  type: string
                categoryId:
                  type: string
                price:
                  type: number
                shelfLifeDays:
                  type: number
                image:
                  type: string
                recipe:
                  type: array
                bundleItems:
                  type: array
      responses:
        '200':
          description: Product updated successfully
        '404':
          description: Product not found
    delete:
      tags:
        - Products
      summary: Delete product
      description: Cannot delete if product is used in production plans or bundles
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Product deleted successfully
        '400':
          description: Cannot delete - product is in use
        '404':
          description: Product not found

  # ============================================================
  # FEATURE 3: PRODUCTION PLANS (Manufacturing Schedule)
  # ============================================================
  /api/production-plans:
    get:
      tags:
        - Production Plans
      summary: Get all production plans
      description: Retrieve production plans with optional status filtering
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: status
          schema:
            type: string
            enum: [Planned, In_Progress, Completed, Cancelled]
          description: Filter by plan status
        - in: query
          name: planDate
          schema:
            type: string
            format: date
          description: Filter by specific date
      responses:
        '200':
          description: Successfully retrieved plans
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  count:
                    type: integer
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ProductionPlan'
    post:
      tags:
        - Production Plans
      summary: Create production plan
      description: |
        Create a new production plan for manufacturing products.
        
        **Important:** Each plan creates a unique planCode and tracks planned vs actual quantities.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - planCode
                - planDate
                - details
              properties:
                planCode:
                  type: string
                  example: 'PLAN-20260129-001'
                  description: 'Unique plan code'
                planDate:
                  type: string
                  format: date
                  example: '2026-01-29'
                  description: 'Planned production date'
                note:
                  type: string
                  example: 'Production for Mid-Autumn Festival'
                status:
                  type: string
                  enum: [Planned, In_Progress, Completed, Cancelled]
                  default: Planned
                details:
                  type: array
                  description: 'List of products to be manufactured'
                  items:
                    type: object
                    required:
                      - productId
                      - plannedQuantity
                    properties:
                      productId:
                        type: string
                        example: '60d5ec49f1b2c8b1f8e4e1a5'
                      plannedQuantity:
                        type: number
                        example: 100
                        description: 'Target quantity to produce'
                      actualQuantity:
                        type: number
                        default: 0
                        description: 'Actual quantity produced (updated during production)'
                      status:
                        type: string
                        enum: [Pending, In_Progress, Completed, Cancelled]
                        default: Pending
      responses:
        '201':
          description: Production plan created successfully
        '400':
          description: Invalid input or duplicate plan code

  /api/production-plans/{id}:
    get:
      tags:
        - Production Plans
      summary: Get production plan by ID
      description: Get detailed plan with all product details populated
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Successfully retrieved plan
        '404':
          description: Plan not found
    put:
      tags:
        - Production Plans
      summary: Update production plan
      description: Update production plan details (Admin, Manager, Kitchen Staff only)
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                planCode:
                  type: string
                  description: 'Unique plan code'
                planDate:
                  type: string
                  format: date
                note:
                  type: string
                status:
                  type: string
                  enum: [Planned, In_Progress, Completed, Cancelled]
                details:
                  type: array
                  items:
                    type: object
                    properties:
                      productId:
                        type: string
                      plannedQuantity:
                        type: number
                      actualQuantity:
                        type: number
                      status:
                        type: string
                        enum: [Pending, In_Progress, Completed, Cancelled]
      responses:
        '200':
          description: Plan updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/ProductionPlan'
        '404':
          description: Plan not found
    delete:
      tags:
        - Production Plans
      summary: Delete production plan
      description: Delete a production plan (Admin, Manager only)
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Production plan deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        '404':
          description: Plan not found
        '400':
          description: Cannot delete plan (e.g., plan has completed items)
    patch:
      tags:
        - Production
      summary: Update production plan status
      description: |
        Update only the status of a production plan (Admin, Manager, Kitchen Staff only).
        
        **Important:** Cannot mark as 'Completed' unless all items in the plan are completed.
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Production Plan ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  type: string
                  enum: [Planned, In_Progress, Completed, Cancelled]
                  description: 'New status for the production plan'
                  example: 'In_Progress'
      responses:
        '200':
          description: Production plan status updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: 'Production plan status updated successfully'
                  data:
                    $ref: '#/components/schemas/ProductionPlan'
        '400':
          description: Invalid status or validation error (e.g., cannot mark as Completed when items are not completed)
        '404':
          description: Production plan not found

  /api/production-plans/{planId}/complete-item:
    post:
      tags:
        - Production
      summary: Complete production item and auto-create finished batch
      description: |
        Mark a production item as complete and automatically create a finished goods batch.
        
        **CRITICAL:** This creates the traceability link: Production Plan → Finished Batch
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: planId
          required: true
          schema:
            type: string
          description: Production Plan ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - productId
                - actualQuantity
              properties:
                productId:
                  type: string
                  example: '60d5ec49f1b2c8b1f8e4e1a5'
                actualQuantity:
                  type: number
                  example: 100
                  description: 'Actual quantity produced'
      responses:
        '201':
          description: Item completed and batch created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      productionPlan:
                        $ref: '#/components/schemas/ProductionPlan'
                      batch:
                        $ref: '#/components/schemas/FinishedBatch'
        '400':
          description: Invalid input or item already completed
        '404':
          description: Plan or product not found

  # ============================================================
  # FEATURE 3: FINISHED BATCHES (Output Traceability)
  # ============================================================
  /api/batches:
    get:
      tags:
        - Finished Batches
      summary: Get all finished goods batches
      description: Retrieve batches of finished products with optional filtering
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: productId
          schema:
            type: string
          description: Filter by product
        - in: query
          name: status
          schema:
            type: string
            enum: [Active, SoldOut, Expired, Recalled]
          description: Filter by batch status
        - in: query
          name: expiring
          schema:
            type: integer
          description: Filter batches expiring within X days
      responses:
        '200':
          description: Successfully retrieved batches
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  count:
                    type: integer
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/FinishedBatch'
    post:
      tags:
        - Finished Batches
      summary: Create finished goods batch (CRITICAL for Traceability)
      description: |
        Create a new batch of finished products.
        
        **CRITICAL REQUIREMENT:** Must link to productionPlanId for full traceability.
        
        **Traceability Chain:** Production Plan → Finished Batch → Store Inventory
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - batchCode
                - productionPlanId
                - productId
                - mfgDate
                - expDate
                - initialQuantity
              properties:
                batchCode:
                  type: string
                  example: 'BATCH-20260129-MOON-GB-001'
                  description: 'Unique batch code (auto-uppercase)'
                productionPlanId:
                  type: string
                  example: '60d5ec49f1b2c8b1f8e4e1a6'
                  description: 'REQUIRED: Links batch back to production plan'
                productId:
                  type: string
                  example: '60d5ec49f1b2c8b1f8e4e1a5'
                  description: 'Product being batched'
                mfgDate:
                  type: string
                  format: date
                  example: '2026-01-29'
                  description: 'Manufacturing date (default: today)'
                expDate:
                  type: string
                  format: date
                  example: '2026-02-28'
                  description: 'Expiration date (must be after mfgDate)'
                initialQuantity:
                  type: number
                  example: 100
                  description: 'Initial quantity produced'
                currentQuantity:
                  type: number
                  example: 100
                  description: 'Current available quantity'
                status:
                  type: string
                  enum: [Active, SoldOut, Expired, Recalled]
                  default: Active
      responses:
        '201':
          description: Batch created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/FinishedBatch'
        '400':
          description: Invalid input (e.g., expDate before mfgDate, duplicate batchCode)
        '404':
          description: Production plan or product not found

  /api/batches/{id}:
    get:
      tags:
        - Finished Batches
      summary: Get finished batch by ID
      description: Get detailed batch information with production plan linkage
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Successfully retrieved batch
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/FinishedBatch'
        '404':
          description: Batch not found
    put:
      tags:
        - Finished Batches
      summary: Update finished batch
      description: Update batch status or adjust quantities
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                currentQuantity:
                  type: number
                status:
                  type: string
                  enum: [Active, SoldOut, Expired, Recalled]
      responses:
        '200':
          description: Batch updated successfully
        '404':
          description: Batch not found

  # FEATURE 4: LOGISTICS & SUPPLY CHAIN
  # ============================================================
  /api/logistics/orders:
    get:
      tags:
        - Logistics
      summary: Get all orders
      description: |
        Retrieve all orders with optional filtering by status and store.
        
        **Traceability:** Order → DeliveryTrip → Store Inventory
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: status
          schema:
            type: string
            enum: [Pending, Approved, Shipped, Received, Cancelled]
          description: Filter by order status
        - in: query
          name: storeId
          schema:
            type: string
          description: Filter by store ID
      responses:
        '200':
          description: Successfully retrieved orders
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Order'
    post:
      tags:
        - Logistics
      summary: Create new order
      description: |
        Create a new order from a store to the central kitchen.
        
        **Client sends:** storeId, requestedDeliveryDate, items (with productId and quantityRequested)
        
        **Backend automatically:**
        - Extracts userId from Bearer Token (authentication required)
        - Generates unique orderNumber (e.g., ORD-20260202-001)
        - Sets status to 'Pending'
        - Sets orderDate to current timestamp
        - Fetches unitPrice from Product collection
        - Calculates subtotal for each item (quantityRequested × unitPrice)
        - Calculates totalAmount (sum of all subtotals)
        
        **Security:** This prevents clients from manipulating prices or order numbers.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - storeId
                - requestedDeliveryDate
                - items
              properties:
                storeId:
                  type: string
                  description: 'Store placing the order'
                  example: '60d5ec49f1b2c8b1f8e4e1a7'
                requestedDeliveryDate:
                  type: string
                  format: date
                  example: '2026-02-05'
                  description: 'Requested delivery date'
                items:
                  type: array
                  description: 'List of products to order'
                  minItems: 1
                  items:
                    type: object
                    required:
                      - productId
                      - quantityRequested
                    properties:
                      productId:
                        type: string
                        description: 'Product ID'
                        example: '60d5ec49f1b2c8b1f8e4e1a5'
                      quantityRequested:
                        type: number
                        minimum: 1
                        example: 20
                        description: 'Quantity to order'
                  example:
                    - productId: '60d5ec49f1b2c8b1f8e4e1a5'
                      quantityRequested: 20
                    - productId: '60d5ec49f1b2c8b1f8e4e1a6'
                      quantityRequested: 15
                notes:
                  type: string
                  description: 'Additional notes or special instructions'
                  example: 'Urgent order for weekend promotion'
      responses:
        '201':
          description: Order created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Order'
        '400':
          description: Invalid input or insufficient inventory

  /api/logistics/orders/{id}:
    get:
      tags:
        - Logistics
      summary: Get order by ID
      description: Retrieve detailed order information with all related data
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Order ID
      responses:
        '200':
          description: Successfully retrieved order
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Order'
        '404':
          description: Order not found
    put:
      tags:
        - Logistics
      summary: Update order
      description: Update order details (Pending orders only)
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                requestedDeliveryDate:
                  type: string
                  format: date
                orderItems:
                  type: array
                  items:
                    type: object
                notes:
                  type: string
      responses:
        '200':
          description: Order updated successfully
        '400':
          description: Cannot update - order already approved or shipped
        '404':
          description: Order not found

  /api/logistics/orders/{id}/cancel:
    post:
      tags:
        - Logistics
      summary: Cancel order
      description: Cancel a pending or approved order
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Order cancelled successfully
        '400':
          description: Cannot cancel - order already shipped
        '404':
          description: Order not found

  /api/logistics/orders/{id}/approve-and-ship:
    post:
      tags:
        - Logistics
      summary: Approve and ship order
      description: |
        Approves an order, creates a delivery trip, generates an invoice, and updates inventory.
        Transitions order status from "Pending" or "Approved" to "Shipped".
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Order ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - driverId
                - vehicleNumber
                - items
              properties:
                driverId:
                  type: string
                  description: ID of the driver assigned to this delivery
                  example: '60d5ec49f1b2c8b1f8e4e1b2'
                vehicleNumber:
                  type: string
                  description: Vehicle license plate or identification number
                  example: '51A-12345'
                items:
                  type: array
                  description: Products being shipped with batch assignments (CRITICAL for traceability)
                  items:
                    type: object
                    required:
                      - batchId
                    properties:
                      batchId:
                        type: string
                        description: 'CRITICAL: Finished batch ID for traceability (Production Plan → Batch → Delivery)'
                        example: '60d5ec49f1b2c8b1f8e4e1c3'
            example:
              driverId: '60d5ec49f1b2c8b1f8e4e1b2'
              vehicleNumber: '51A-12345'
              items:
                - batchId: '60d5ec49f1b2c8b1f8e4e1c3'
                - batchId: '60d5ec49f1b2c8b1f8e4e1c4'
                - batchId: '60d5ec49f1b2c8b1f8e4e1c5'
      responses:
        '200':
          description: Order approved and shipped successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  order:
                    $ref: '#/components/schemas/Order'
                  deliveryTrip:
                    $ref: '#/components/schemas/DeliveryTrip'
                  invoice:
                    $ref: '#/components/schemas/Invoice'
        '400':
          description: Invalid input or order already shipped
        '404':
          description: Order not found

  /api/logistics/orders/{id}/receive:
    post:
      tags:
        - Logistics
      summary: Receive order at store
      description: |
        Mark an order as received by the store (QR scan or manual confirmation).
        Updates delivery trip status to "Delivered", updates store inventory, 
        and transitions order status to "Received".
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Order ID
      responses:
        '200':
          description: Order received successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  order:
                    $ref: '#/components/schemas/Order'
                  deliveryTrip:
                    $ref: '#/components/schemas/DeliveryTrip'
                  storeInventories:
                    type: array
                    items:
                      $ref: '#/components/schemas/StoreInventory'
        '400':
          description: Invalid operation (e.g., order not shipped yet)
        '404':
          description: Order or delivery trip not found

  /api/logistics/delivery-trips:
    get:
      tags:
        - Logistics
      summary: Get all delivery trips
      description: |
        Retrieve all delivery trips with optional filtering.
        
        **CRITICAL TRACEABILITY:** Each trip links orders to specific finished batches via exportDetails.
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: status
          schema:
            type: string
            enum: [Pending, InTransit, Completed, Cancelled]
          description: Filter by trip status
        - in: query
          name: storeId
          schema:
            type: string
          description: Filter by destination store
        - in: query
          name: orderId
          schema:
            type: string
          description: Filter by order
      responses:
        '200':
          description: Successfully retrieved delivery trips
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/DeliveryTrip'
    post:
      tags:
        - Logistics
      summary: Create delivery trip (CRITICAL for Traceability)
      description: |
        Create a new delivery trip to ship orders to stores.
        
        **CRITICAL WORKFLOW:**
        1. Kitchen Manager reviews the approved order
        2. Assigns specific finished batches to fulfill the order using FEFO logic (First Expired, First Out)
        3. Backend auto-generates unique tripNumber (e.g., TRIP-20260202-001)
        4. exportDetails creates the traceability link: Production Plan → Finished Batch → Delivery Trip → Store Inventory
        
        **Security:** userId extracted from Bearer Token to track who created the trip.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - orderId
                - storeId
                - departureDate
                - estimatedArrival
                - exportDetails
              properties:
                orderId:
                  type: string
                  description: 'Order being fulfilled'
                  example: '60d5ec49f1b2c8b1f8e4e1a9'
                storeId:
                  type: string
                  description: 'Destination store'
                  example: '60d5ec49f1b2c8b1f8e4e1a7'
                driverId:
                  type: string
                  description: 'Optional: Driver/coordinator assigned to this trip'
                  example: '60d5ec49f1b2c8b1f8e4e1b2'
                departureDate:
                  type: string
                  format: date-time
                  example: '2026-02-05T08:00:00Z'
                  description: 'Scheduled departure time'
                estimatedArrival:
                  type: string
                  format: date-time
                  example: '2026-02-05T08:45:00Z'
                  description: 'Estimated arrival time at store'
                exportDetails:
                  type: array
                  description: 'CRITICAL: List of items with specific batch assignments (FEFO logic)'
                  minItems: 1
                  items:
                    type: object
                    required:
                      - productId
                      - batchId
                      - quantity
                    properties:
                      productId:
                        type: string
                        description: 'Product being shipped'
                        example: '60d5ec49f1b2c8b1f8e4e1a5'
                      batchId:
                        type: string
                        description: 'CRITICAL: Specific finished batch (Kitchen Manager assigns using FEFO)'
                        example: '60d5ec49f1b2c8b1f8e4e1a8'
                      quantity:
                        type: number
                        minimum: 1
                        example: 20
                        description: 'Quantity from this batch'
                  example:
                    - productId: '60d5ec49f1b2c8b1f8e4e1a5'
                      batchId: '60d5ec49f1b2c8b1f8e4e1a8'
                      quantity: 20
      responses:
        '201':
          description: Delivery trip created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/DeliveryTrip'
        '400':
          description: Invalid input or insufficient batch quantity
        '404':
          description: Order, store, or batch not found

  /api/logistics/delivery-trips/{id}:
    get:
      tags:
        - Logistics
      summary: Get delivery trip by ID
      description: Retrieve detailed delivery trip information with batch traceability
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Successfully retrieved delivery trip
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/DeliveryTrip'
        '404':
          description: Delivery trip not found

  /api/logistics/delivery-trips/{id}/depart:
    post:
      tags:
        - Logistics
      summary: Mark trip as departed
      description: Update trip status to InTransit and record actual departure time
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Trip marked as departed
        '400':
          description: Trip already departed or cancelled
        '404':
          description: Trip not found

  /api/logistics/invoices:
    get:
      tags:
        - Logistics
      summary: Get all invoices
      description: |
        Retrieve all invoices with optional filtering.
        
        **IMPORTANT:** Invoices are automatically generated by the system when:
        - An Order is approved, OR
        - A Delivery Trip is created
        
        Manual invoice creation is NOT allowed to ensure data consistency and prevent billing errors.
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: paymentStatus
          schema:
            type: string
            enum: [Pending, Partial, Paid, Overdue, Cancelled]
          description: Filter by payment status
        - in: query
          name: storeId
          schema:
            type: string
          description: Filter by store
        - in: query
          name: orderId
          schema:
            type: string
          description: Filter by order
      responses:
        '200':
          description: Successfully retrieved invoices
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Invoice'

  /api/logistics/invoices/{id}:
    get:
      tags:
        - Logistics
      summary: Get invoice by ID
      description: Retrieve detailed invoice information
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Successfully retrieved invoice
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Invoice'
        '404':
          description: Invoice not found

  /api/logistics/invoices/{id}/payment:
    post:
      tags:
        - Logistics
      summary: Record payment
      description: Record a payment against an invoice (full or partial)
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - amount
              properties:
                amount:
                  type: number
                  description: 'Payment amount'
                paymentDate:
                  type: string
                  format: date
                  description: 'Payment date (default: today)'
                paymentMethod:
                  type: string
                  description: 'Payment method description'
      responses:
        '200':
          description: Payment recorded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Invoice'
        '400':
          description: Invalid amount or invoice already paid
        '404':
          description: Invoice not found

  # ============================================================
  # FEATURE 5: STORE INVENTORY & OPERATIONS
  # ============================================================
  /api/inventory/store/{storeId}:
    get:
      tags:
        - Inventory
      summary: Get store inventory
      description: |
        View current inventory for a specific store with batch-level traceability.
        
        **Traceability:** Shows which finished batch each store's stock came from.
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: storeId
          required: true
          schema:
            type: string
          description: Store ID
        - in: query
          name: productId
          schema:
            type: string
          description: Filter by product
        - in: query
          name: lowStock
          schema:
            type: boolean
          description: Show only low stock items
      responses:
        '200':
          description: Successfully retrieved inventory
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  storeName:
                    type: string
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        _id:
                          type: string
                        storeId:
                          type: string
                        productId:
                          type: object
                          description: 'Populated product details'
                        batchId:
                          type: object
                          description: 'Populated batch details with expiry'
                        quantity:
                          type: number
                        createdAt:
                          type: string
                        updatedAt:
                          type: string
        '404':
          description: Store not found

  /api/inventory/expiring:
    get:
      tags:
        - Inventory
      summary: Get expiring inventory across all stores
      description: Find products nearing expiration for proactive management
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: days
          schema:
            type: integer
            default: 7
          description: Number of days to look ahead
      responses:
        '200':
          description: Successfully retrieved expiring items

  # ============================================================
  # FEATURE 1: STORES MANAGEMENT
  # ============================================================
  /api/stores:
    get:
      tags:
        - Stores
      summary: Get all stores
      description: Retrieve a list of all retail stores in the system
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Successfully retrieved stores
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        _id:
                          type: string
                        name:
                          type: string
                        address:
                          type: string
                        phone_number:
                          type: string
                        store_code:
                          type: string
                        status:
                          type: string
                          enum: [Active, Inactive]
    post:
      tags:
        - Stores
      summary: Create new store
      description: Register a new retail store location
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - address
                - phone_number
                - store_code
              properties:
                name:
                  type: string
                  example: 'Kendo Mooncake - District 1'
                address:
                  type: string
                  example: '123 Nguyen Hue Street, District 1, HCMC'
                phone_number:
                  type: string
                  example: '0901234567'
                store_code:
                  type: string
                  example: 'KD-D1-001'
                status:
                  type: string
                  enum: [Active, Inactive]
                  default: Active
      responses:
        '201':
          description: Store created successfully
        '400':
          description: Invalid input data
        '401':
          description: Unauthorized

  /api/stores/{id}:
    get:
      tags:
        - Stores
      summary: Get store by ID
      description: Retrieve detailed information about a specific store
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Store ID
      responses:
        '200':
          description: Successfully retrieved store details
        '404':
          description: Store not found
    put:
      tags:
        - Stores
      summary: Update store information
      description: Update details of an existing store
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Store ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                address:
                  type: string
                phone_number:
                  type: string
                store_code:
                  type: string
                status:
                  type: string
                  enum: [Active, Inactive]
      responses:
        '200':
          description: Store updated successfully
        '404':
          description: Store not found
        '400':
          description: Invalid input data
    delete:
      tags:
        - Stores
      summary: Delete or deactivate store
      description: Soft delete or deactivate a store (sets status to Inactive)
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Store ID
      responses:
        '200':
          description: Store deactivated successfully
        '404':
          description: Store not found

  /api/users:
    get:
      tags:
        - Users
      summary: Get all users
      description: Retrieve a list of all registered users and staff (Admin only)
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: roleId
          schema:
            type: string
          description: Filter by role ID
        - in: query
          name: status
          schema:
            type: string
            enum: [Active, Inactive]
          description: Filter by account status
        - in: query
          name: storeId
          schema:
            type: string
          description: Filter by assigned store
      responses:
        '200':
          description: Successfully retrieved users
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        _id:
                          type: string
                        username:
                          type: string
                        fullName:
                          type: string
                        email:
                          type: string
                        roleId:
                          type: string
                        storeId:
                          type: string
                        status:
                          type: string
                        createdAt:
                          type: string
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Admin access required

  paths:
  # Route cho Create User
  /api/users:
    post:
      tags:
        - Users
      summary: Create new user
      description: Create a new user (Admin/Manager only). Validates role and store assignment.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
                - fullName
                - email
                - roleId
              properties:
                username:
                  type: string
                  example: "staff01"
                password:
                  type: string
                  format: password
                  example: "Pass123456"
                fullName:
                  type: string
                  example: "Nguyen Van A"
                email:
                  type: string
                  format: email
                  example: "staff01@example.com"
                roleId:
                  type: string
                  description: ObjectId of the Role
                  example: "60d5ec49f1b2c8b1f8e4e1a1"
                storeId:
                  type: string
                  description: Required if role is StoreStaff, otherwise null
                  example: "60d5ec49f1b2c8b1f8e4e1b2"
      responses:
        '201':
          description: User created successfully
        '400':
          description: Validation Error (Duplicate user, Invalid Role/Store, or Missing StoreId for Staff)
        '403':
          description: Forbidden (Admin/Manager only)

  # Route cho GetById, Update, Delete
  /api/users/{id}:
    parameters:
      - in: path
        name: id
        required: true
        schema:
          type: string
        description: User ID
    
    # Get Single User (getUserById)
    get:
      tags:
        - Users
      summary: Get user by ID
      description: Retrieve detailed information of a specific user
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User details retrieved
        '404':
          description: User not found

    # Update User (updateUser - Gộp cả update info, role, store, password)
    put:
      tags:
        - Users
      summary: Update user details
      description: Update user info. Can update Role, Store, Password, or Profile info. Handles logic for StoreStaff validation.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                fullName:
                  type: string
                  example: "Nguyen Van B"
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
                  description: Send this only if you want to change the password
                roleId:
                  type: string
                  description: ObjectId of the new Role
                storeId:
                  type: string
                  description: Required if changing role to StoreStaff
      responses:
        '200':
          description: User updated successfully
        '400':
          description: Validation Error (Invalid Role/Store logic)
        '404':
          description: User not found

    # Soft Delete User (deleteUser)
    delete:
      tags:
        - Users
      summary: Deactivate user (Soft Delete)
      description: Sets the user's isActive status to false.
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User deactivated successfully
        '404':
          description: User not found

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Enter your JWT token (obtained from /api/auth/login)

  schemas:
    # ============================================================
    # FEATURE 2: SUPPLIER SCHEMA
    # ============================================================
    Supplier:
      type: object
      properties:
        _id:
          type: string
          example: '60d5ec49f1b2c8b1f8e4e1a1'
        name:
          type: string
          example: 'Golden Harvest Supplier'
        contactPerson:
          type: string
          example: 'Nguyen Van A'
        phone:
          type: string
          example: '+84-28-12345678'
        email:
          type: string
          example: 'contact@goldenharvest.vn'
        address:
          type: string
          example: 'Industrial Zone, Binh Duong Province'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    # ============================================================
    # FEATURE 2: INGREDIENT SCHEMA (Updated)
    # ============================================================
    Ingredient:
      type: object
      properties:
        _id:
          type: string
        ingredientName:
          type: string
          example: 'Flour'
          description: 'Unique ingredient name'
        unit:
          type: string
          example: 'kg'
          description: 'Unit of measurement (stored in lowercase)'
        costPrice:
          type: number
          example: 25000
          description: 'Cost per unit in VND'
        warningThreshold:
          type: number
          example: 100
          description: 'Low stock alert threshold'
        totalQuantity:
          type: number
          example: 500
          description: 'Total quantity across all active batches'
        isBelowThreshold:
          type: boolean
          description: 'Virtual field: true if totalQuantity < warningThreshold'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    # ============================================================
    # FEATURE 2: INGREDIENT BATCH SCHEMA (New)
    # ============================================================
    IngredientBatch:
      type: object
      properties:
        _id:
          type: string
        ingredientId:
          type: string
          description: 'Reference to Ingredient'
        supplierId:
          type: string
          description: 'Reference to Supplier (CRITICAL for traceability)'
        batchCode:
          type: string
          example: 'IB-FLOUR-20260129-001'
          description: 'Unique batch code (auto-uppercase)'
        expiryDate:
          type: string
          format: date
          example: '2026-12-31'
          description: 'Expiry date (must be future date)'
        receivedDate:
          type: string
          format: date
          example: '2026-01-29'
          description: 'Date received from supplier'
        initialQuantity:
          type: number
          example: 500
          description: 'Original quantity when imported'
        currentQuantity:
          type: number
          example: 500
          description: 'Current remaining quantity'
        price:
          type: number
          example: 25000
          description: 'Price per unit for this batch'
        isActive:
          type: boolean
          default: true
          description: 'Batch is still usable'
        isExpired:
          type: boolean
          description: 'Virtual field: true if expiryDate < today'
        isEmpty:
          type: boolean
          description: 'Virtual field: true if currentQuantity <= 0'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    # ============================================================
    # FEATURE 3: PRODUCT SCHEMA (with Recipe & Bundles)
    # ============================================================
    Product:
      type: object
      properties:
        _id:
          type: string
        name:
          type: string
          example: 'Green Bean Mooncake'
        sku:
          type: string
          example: 'MOON-GB-001'
          description: 'Unique product code'
        categoryId:
          type: string
          description: 'Reference to Category'
        price:
          type: number
          example: 150000
          description: 'Selling price in VND'
        unit:
          type: string
          example: 'Box'
          description: 'Unit of measurement for the finished product (e.g., Box, Piece, Set)'
        shelfLifeDays:
          type: number
          example: 30
          description: 'Shelf life in days'
        image:
          type: string
          example: 'https://example.com/mooncake.jpg'
        recipe:
          type: array
          description: 'Ingredients needed to make 1 unit'
          items:
            type: object
            properties:
              ingredientId:
                type: string
              quantity:
                type: number
                description: 'Quantity per 1 unit of product'
          example:
            - ingredientId: '60d5ec49f1b2c8b1f8e4e1a2'
              quantity: 0.05
            - ingredientId: '60d5ec49f1b2c8b1f8e4e1a3'
              quantity: 1
        bundleItems:
          type: array
          description: 'Child products for combo/bundle products'
          items:
            type: object
            properties:
              childProductId:
                type: string
              quantity:
                type: number
          example:
            - childProductId: '60d5ec49f1b2c8b1f8e4e1a4'
              quantity: 2
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    # ============================================================
    # FEATURE 3: PRODUCTION PLAN SCHEMA
    # ============================================================
    ProductionPlan:
      type: object
      properties:
        _id:
          type: string
        planCode:
          type: string
          example: 'PLAN-20260129-001'
          description: 'Unique plan code (auto-uppercase)'
        planDate:
          type: string
          format: date
          example: '2026-01-29'
          description: 'Planned production date'
        status:
          type: string
          enum: [Planned, In_Progress, Completed, Cancelled]
          example: 'Completed'
        note:
          type: string
          example: 'Production for Mid-Autumn Festival'
        details:
          type: array
          description: 'Products to be manufactured'
          items:
            type: object
            properties:
              productId:
                type: string
              plannedQuantity:
                type: number
                example: 100
              actualQuantity:
                type: number
                example: 100
              status:
                type: string
                enum: [Pending, In_Progress, Completed, Cancelled]
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    # ============================================================
    # FEATURE 3: FINISHED BATCH SCHEMA (CRITICAL for Traceability)
    # ============================================================
    FinishedBatch:
      type: object
      required:
        - batchCode
        - productionPlanId
        - productId
        - mfgDate
        - expDate
        - initialQuantity
      properties:
        _id:
          type: string
        batchCode:
          type: string
          example: 'BATCH-20260129-MOON-GB-001'
          description: 'Unique batch code (auto-uppercase)'
        productionPlanId:
          type: string
          example: '60d5ec49f1b2c8b1f8e4e1a6'
          description: 'CRITICAL: Links batch back to production plan for traceability'
        productId:
          type: string
          example: '60d5ec49f1b2c8b1f8e4e1a5'
          description: 'Product being batched'
        mfgDate:
          type: string
          format: date
          example: '2026-01-29'
          description: 'Manufacturing date'
        expDate:
          type: string
          format: date
          example: '2026-02-28'
          description: 'Expiration date (must be after mfgDate)'
        initialQuantity:
          type: number
          example: 100
          description: 'Initial quantity produced'
        currentQuantity:
          type: number
          example: 80
          description: 'Current available quantity (after deliveries to stores)'
        status:
          type: string
          enum: [Active, SoldOut, Expired, Recalled]
          default: Active
          description: 'Batch status for inventory management'
        isExpired:
          type: boolean
          description: 'Virtual field: true if expDate < today'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    # ============================================================
    # FEATURE 4: LOGISTICS SCHEMAS
    # ============================================================
    Order:
      type: object
      required:
        - orderNumber
        - storeId
        - orderDate
        - requestedDeliveryDate
        - items
        - totalAmount
        - status
      properties:
        _id:
          type: string
        orderNumber:
          type: string
          example: 'ORD-20260130-001'
          description: 'Unique order number (auto-uppercase)'
        storeId:
          type: string
          description: 'Store placing the order'
        orderDate:
          type: string
          format: date-time
          example: '2026-01-30T00:00:00Z'
          description: 'Order creation date'
        requestedDeliveryDate:
          type: string
          format: date
          example: '2026-01-30'
          description: 'Requested delivery date'
        items:
          type: array
          description: 'Items in the order'
          items:
            type: object
            required:
              - productId
              - quantityRequested
              - unitPrice
              - subtotal
            properties:
              productId:
                type: string
                description: 'Product reference'
              quantityRequested:
                type: number
                minimum: 1
                example: 20
                description: 'Quantity requested by store'
              quantity:
                type: number
                minimum: 0
                example: 20
                description: 'Quantity fulfilled (may differ from quantityRequested if stock limited)'
              batchId:
                type: string
                description: 'Optional: Finished batch reference (assigned during fulfillment)'
              unitPrice:
                type: number
                example: 150000
                description: 'Price per unit in VND (from Product collection)'
              subtotal:
                type: number
                example: 3000000
                description: 'Line total (quantity * unitPrice)'
        totalAmount:
          type: number
          example: 3000000
          description: 'Total order amount in VND'
        status:
          type: string
          enum: [Pending, Approved, Shipped, Received, Cancelled]
          default: Pending
          description: 'Current order status'
        approvedBy:
          type: string
          description: 'User ID who approved the order'
        approvedAt:
          type: string
          format: date-time
          description: 'Approval timestamp'
        notes:
          type: string
          description: 'Additional notes or instructions'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    DeliveryTrip:
      type: object
      required:
        - tripNumber
        - orderId
        - storeId
        - departureDate
        - estimatedArrival
        - exportDetails
      properties:
        _id:
          type: string
        tripNumber:
          type: string
          example: 'TRIP-20260130-001'
          description: 'Unique trip number (auto-uppercase)'
        orderId:
          type: string
          description: 'Order being fulfilled by this trip'
        storeId:
          type: string
          description: 'Destination store'
        driverId:
          type: string
          description: 'Driver/coordinator assigned to trip'
        exportDetails:
          type: array
          description: 'CRITICAL: Items shipped with batch assignments. Kitchen Manager uses FEFO (First Expired, First Out) logic to select batches. This creates the traceability link from Finished Batch to Store Inventory.'
          items:
            type: object
            required:
              - productId
              - batchId
              - quantity
            properties:
              productId:
                type: string
                description: 'Product being shipped'
                example: '60d5ec49f1b2c8b1f8e4e1a5'
              batchId:
                type: string
                description: 'CRITICAL: Traceability link to Finished Batch. This specific batch will be tracked to store inventory.'
                example: '60d5ec49f1b2c8b1f8e4e1a8'
              quantity:
                type: number
                minimum: 1
                example: 20
                description: 'Quantity from this specific batch'
        departureDate:
          type: string
          format: date-time
          example: '2026-01-30T08:00:00Z'
          description: 'Scheduled/actual departure time'
        estimatedArrival:
          type: string
          format: date-time
          example: '2026-01-30T08:45:00Z'
          description: 'Estimated arrival time'
        actualArrival:
          type: string
          format: date-time
          description: 'Actual arrival time (set when received)'
        status:
          type: string
          enum: [Pending, InTransit, Completed, Cancelled]
          default: Pending
          description: 'Current trip status'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Invoice:
      type: object
      description: |
        Invoice for order billing. AUTO-GENERATED ONLY - system creates invoices when orders are approved or delivery trips are created.
        Manual invoice creation is prohibited to maintain financial data integrity.
      required:
        - invoiceNumber
        - orderId
        - storeId
        - invoiceDate
        - dueDate
        - subtotal
        - totalAmount
        - paymentStatus
      properties:
        _id:
          type: string
        invoiceNumber:
          type: string
          example: 'INV-20260130-001'
          description: 'Unique invoice number (auto-generated, auto-uppercase)'
        orderId:
          type: string
          description: 'Reference to Order (see Order schema). CRITICAL: Links invoice to specific order for traceability.'
          example: '60d5ec49f1b2c8b1f8e4e1a9'
        storeId:
          type: string
          description: 'Reference to Store (see Store schema). The store being billed for this order.'
          example: '60d5ec49f1b2c8b1f8e4e1a7'
        invoiceDate:
          type: string
          format: date
          example: '2026-01-30'
          description: 'Invoice issue date'
        dueDate:
          type: string
          format: date
          example: '2026-02-13'
          description: 'Payment due date'
        subtotal:
          type: number
          example: 3000000
          description: 'Order subtotal before tax'
        taxRate:
          type: number
          example: 8
          description: 'Tax rate percentage (0-100)'
        taxAmount:
          type: number
          example: 240000
          description: 'Calculated tax amount'
        totalAmount:
          type: number
          example: 3240000
          description: 'Total amount including tax'
        paymentStatus:
          type: string
          enum: [Pending, Partial, Paid, Overdue, Cancelled]
          default: Pending
          description: 'Current payment status'
        paidAmount:
          type: number
          default: 0
          description: 'Amount paid so far'
        paymentDate:
          type: string
          format: date
          description: 'Date payment was completed'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    # ============================================================
    # ADDITIONAL SCHEMAS
    # ============================================================
    Category:
      type: object
      properties:
        _id:
          type: string
        categoryName:
          type: string
          example: 'Mooncake'
        description:
          type: string
          example: 'Traditional and modern mooncake products'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Store:
      type: object
      properties:
        _id:
          type: string
        storeName:
          type: string
          example: 'Kendo Q1 Branch'
        storeCode:
          type: string
          example: 'KD-Q1'
        address:
          type: string
          example: '123 Nguyen Hue Street, District 1, HCMC'
        phone:
          type: string
          example: '+84-28-12345678'
        standardDeliveryMinutes:
          type: number
          example: 30
        status:
          type: string
          enum: [Active, Inactive]
          default: Active
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Feedback:
      type: object
      required:
        - orderId
        - rating
      properties:
        _id:
          type: string
          example: '60d5ec49f1b2c8b1f8e4e1a9'
        orderId:
          type: string
          example: '60d5ec49f1b2c8b1f8e4e1a8'
          description: 'Reference to Order'
        rating:
          type: integer
          minimum: 1
          maximum: 5
          example: 5
          description: 'Rating from 1 (poor) to 5 (excellent)'
        content:
          type: string
          example: 'Great quality mooncakes, delivered on time!'
          description: 'Feedback comment'
        images:
          type: array
          items:
            type: string
          example: ['https://example.com/image1.jpg', 'https://example.com/image2.jpg']
          description: 'Array of image URLs'
        createdBy:
          type: string
          description: 'Reference to User who created the feedback'
        createdAt:
          type: string
          format: date-time
          example: '2026-02-05T10:30:00.000Z'
        updatedAt:
          type: string
          format: date-time

    Error:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
          example: 'Error message description'
        error:
          type: string
